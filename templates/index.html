<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Guess the TV Show</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: white;
    text-align: center;
    margin: 0;
    padding: 20px;
  }
  h1 { margin-bottom: 10px; }

  .autocomplete-container {
    position: relative;
    display: inline-block;
    margin-bottom: 10px;
    width: 90%;
    max-width: 320px;
  }
  input {
    padding: 8px;
    border-radius: 5px;
    width: 100%;
    border: none;
    box-sizing: border-box;
    font-size: 16px;
  }
  button {
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    border: none;
    background: #0bf;
    color: #fff;
    margin-top: 6px;
    width: 100%;
  }
  #autocomplete-results {
    background: #222;
    border: 1px solid #555;
    border-radius: 6px;
    position: absolute;
    top: 40px;
    left: 0;
    right: 0;
    z-index: 1000;
    color: white;
    overflow-y: auto;
    max-height: 240px;
    display: none;
  }
  .autocomplete-item {
    padding: 8px 10px;
    cursor: pointer;
  }
  .autocomplete-item:hover { background: #333; }

  .message { margin-top: 10px; color: #ddd; font-size: 14px; }

  .poster-container {
    position: relative;
    display: inline-block;
    margin: 20px auto;
    width: 90%;
    max-width: 300px;
  }
  .poster {
    width: 100%;
    height: auto;
    border-radius: 12px;
    object-fit: cover;
    transition: filter 0.8s ease;
    display: block;
    user-select: none;
    pointer-events: none;
    background-size: cover;
    background-position: center;
    aspect-ratio: 2/3;
  }

  #results-overlay {
    display: none;
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.85);
    color: #fff;
    border-radius: 12px;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10;
    padding: 10px;
    box-sizing: border-box;
  }
  #results-overlay button {
    margin: 6px;
    width: 140px;
  }
  #like-dislike {
    margin-top: 10px;
    font-size: 16px;
  }

  .guess-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
    max-width: 100%;
    margin: 10px auto;
  }
  .tile {
    padding: 6px 4px;
    border-radius: 6px;
    font-weight: bold;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .grid-header .tile { background: #222; font-weight: bold; }

  @media (max-width: 600px) {
    .tile { font-size: 11px; padding: 4px 2px; }
    input, button { font-size: 16px; }
  }
  @media (max-width: 400px) {
    .tile { font-size: 10px; padding: 3px 2px; }
  }

  /* Hidden SEO text */
  .seo-text { position:absolute; left:-9999px; top:-9999px; }
</style>
</head>
<body>

<h1>ðŸŽ¬ Guess the TV Show</h1>

<div class="seo-text">
  Test your knowledge of popular TV shows in 2025!
  Wondering what to watch tonight? Play our quiz to discover trending series.
</div>

<div class="autocomplete-container">
  <form id="guess-form">
    <input id="guess-input" name="guess" placeholder="Enter TV show..." autocomplete="off" required />
    <button type="submit">Guess</button>
  </form>
  <div id="autocomplete-results"></div>
</div>

<div id="message" class="message"></div>

<div class="guess-grid grid-header">
  <div class="tile">Network</div>
  <div class="tile">Year</div>
  <div class="tile">Genre</div>
  <div class="tile">Seasons</div>
  <div class="tile">Status</div>
</div>

<div id="guess-grid" class="guess-grid"></div>

<div class="poster-container">
  {% set remaining = max_guesses - guesses|length %}
  {% set blur_level = (80 * remaining**1) // (max_guesses**1) %}
  {% if target.poster %}
    <div id="poster-img"
      class="poster"
      style="background-image:url('https://image.tmdb.org/t/p/w300{{ target.poster }}'); filter: blur({{ blur_level }}px);">
    </div>
  {% else %}
    <div id="poster-img" class="poster" style="background:#222; height:450px;"></div>
  {% endif %}

  <div id="results-overlay">
    <pre id="emoji-grid" style="text-align:center; font-size:18px;"></pre>
    <div id="like-dislike"></div>
    <button id="share-btn">Share Results</button>
    <button id="watch-trailer-btn">Watch Trailer</button>
  </div>
</div>

<script>
const guessInput = document.getElementById('guess-input');
const autocompleteResults = document.getElementById('autocomplete-results');
const form = document.getElementById('guess-form');
const guessGrid = document.getElementById('guess-grid');
const posterImg = document.getElementById('poster-img');
const messageDiv = document.getElementById('message');
const resultsOverlay = document.getElementById('results-overlay');
const emojiGridEl = document.getElementById('emoji-grid');
const shareBtn = document.getElementById('share-btn');
const watchTrailerBtn = document.getElementById('watch-trailer-btn');
const likeDislikeDiv = document.getElementById('like-dislike');

let debounceTimer = null;
let lastQuery = "";

// Store client-side blur tracking
const MAX_GUESSES = {{ max_guesses }};
let currentGuessCount = {{ guesses|length }};

// render guesses
function renderGuesses(guesses) {
  if (!Array.isArray(guesses) || guesses.length === 0) {
    guessGrid.innerHTML = "";
    return;
  }
  let html = "";
  guesses.forEach(g => {
    const c = g.compare || {};
    html += `<div class="tile" style="background:${c.network?.color || '#555'}">${g.guess.network}</div>`;
    html += `<div class="tile" style="background:${c.first_air_year?.color || '#555'}">${g.guess.first_air_year} ${c.first_air_year?.arrow || ''}</div>`;
    html += `<div class="tile" style="background:${c.genre?.color || '#555'}">${g.guess.genre}</div>`;
    html += `<div class="tile" style="background:${c.number_of_seasons?.color || '#555'}">${g.guess.number_of_seasons} ${c.number_of_seasons?.arrow || ''}</div>`;
    html += `<div class="tile" style="background:${c.status?.color || '#555'}">${g.guess.status}</div>`;
  });
  guessGrid.innerHTML = html;
}

// build emoji grid
function buildEmojiGrid(guesses) {
  let grid = '';
  guesses.forEach(g => {
    const c = g.compare || {};
    const row = [
      c.network?.color === 'green' ? 'ðŸ“º' : (c.network?.color === 'yellow' ? 'ðŸŸ¡' : 'â¬›'),
      c.first_air_year?.color === 'green' ? 'ðŸ“º' : (c.first_air_year?.color === 'yellow' ? 'ðŸŸ¡' : 'â¬›'),
      c.genre?.color === 'green' ? 'ðŸ“º' : (c.genre?.color === 'yellow' ? 'ðŸŸ¡' : 'â¬›'),
      c.number_of_seasons?.color === 'green' ? 'ðŸ“º' : (c.number_of_seasons?.color === 'yellow' ? 'ðŸŸ¡' : 'â¬›'),
      c.status?.color === 'green' ? 'ðŸ“º' : (c.status?.color === 'yellow' ? 'ðŸŸ¡' : 'â¬›')
    ];
    grid += row.join('') + '\n';
  });
  return grid;
}

// show overlay
function showResultsOverlay(guesses, trailer, likes=75, dislikes=25) {
  emojiGridEl.textContent = buildEmojiGrid(guesses);
  likeDislikeDiv.innerHTML = `ðŸ‘ ${likes}% &nbsp; ðŸ‘Ž ${dislikes}%`;
  resultsOverlay.style.display = 'flex';

  shareBtn.onclick = () => {
    const text = buildEmojiGrid(guesses) + "\nPlay here: https://showtime-production-4f0b.up.railway.app/";
    navigator.clipboard.writeText(text);
    alert("Results copied!");
  };

  watchTrailerBtn.onclick = () => {
    if(trailer) {
      let existingIframe = document.getElementById('trailer-iframe');
      if(!existingIframe){
        const iframe = document.createElement('iframe');
        iframe.id = 'trailer-iframe';
        iframe.src = trailer;
        iframe.frameBorder = "0";
        iframe.allowFullscreen = true;
        iframe.style.width = "100%";
        iframe.style.height = "300px";
        iframe.style.borderRadius = "8px";
        iframe.style.zIndex = "20";
        iframe.style.position = "relative";
        iframe.style.marginTop = "10px";
        resultsOverlay.appendChild(iframe);
      }
      document.getElementById('trailer-iframe').scrollIntoView({behavior: "smooth"});
    }
  };
}

// Autocomplete
guessInput.addEventListener('input', (e) => {
  const q = e.target.value.trim();
  if (!q) { autocompleteResults.style.display = 'none'; autocompleteResults.innerHTML = ''; return; }
  if (q === lastQuery) return;
  lastQuery = q;
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(async () => {
    try {
      const res = await fetch(`/autocomplete?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      autocompleteResults.innerHTML = "";
      if (!data.results || data.results.length === 0) { autocompleteResults.style.display = 'none'; return; }
      data.results.forEach(item => {
        const div = document.createElement('div');
        div.className = 'autocomplete-item';
        div.textContent = `${item.name} (${item.year})`;
        div.addEventListener('click', () => {
          guessInput.value = item.name;
          autocompleteResults.innerHTML = "";
          autocompleteResults.style.display = 'none';
        });
        autocompleteResults.appendChild(div);
      });
      autocompleteResults.style.display = 'block';
    } catch (err) { console.error('Autocomplete error', err); autocompleteResults.style.display = 'none'; }
  }, 250);
});
document.addEventListener('click', (e) => {
  if (!autocompleteResults.contains(e.target) && e.target !== guessInput)
    autocompleteResults.style.display = 'none';
});

// Submit guess
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const guess = guessInput.value.trim();
  if (!guess) return;
  messageDiv.textContent = "Submitting guess...";
  try {
    const formData = new FormData();
    formData.append('guess', guess);
    const res = await fetch('/guess', { method: 'POST', body: formData });
    const data = await res.json();
    if (res.status !== 200) {
      messageDiv.textContent = data.error || "Error submitting guess";
      return;
    }
    renderGuesses(data.guesses || []);
    currentGuessCount++;
    let remaining = Math.max(0, MAX_GUESSES - currentGuessCount);
    let blur = Math.ceil((40 * Math.pow(remaining, 2.5)) / Math.pow(MAX_GUESSES, 2.5));
    posterImg.style.filter = `blur(${blur}px)`;
    if (data.game_over && data.target) showResultsOverlay(data.guesses, data.target.trailer, data.target.like_percent, data.target.dislike_percent);
    messageDiv.textContent = data.winner ? "ðŸŽ‰ You guessed it!" : "";
    guessInput.value = "";
    autocompleteResults.innerHTML = "";
    autocompleteResults.style.display = "none";
  } catch (err) {
    console.error(err);
    messageDiv.textContent = "Network or server error.";
  }
});

{% if game_over %}
showResultsOverlay({{ guesses|tojson }}, "{{ target.trailer }}", {{ target.like_percent }}, {{ target.dislike_percent }});
{% endif %}
</script>

</body>
</html>
