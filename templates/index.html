<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Guess the TV Show</title>
<style>
  body { font-family: Arial, sans-serif; background: #111; color: white; text-align: center; margin: 0; padding: 20px; }
  h1 { margin-bottom: 10px; }

  .autocomplete-container { position: relative; display: inline-block; margin-bottom: 10px; width: 90%; max-width: 320px; }
  input {
    padding: 8px;
    border-radius: 5px;
    width: 100%;
    border: none;
    box-sizing: border-box;
    font-size: 16px; /* prevents mobile zoom */
  }
  button { padding: 8px 12px; border-radius: 5px; cursor: pointer; border: none; background: #0bf; color: #fff; margin-top: 6px; width: 100%; }

  #autocomplete-results { background: #222; border: 1px solid #555; border-radius: 6px; position: absolute; top: 40px; left: 0; right: 0; z-index: 1000; color: white; overflow-y: auto; max-height: 240px; display: none; }
  .autocomplete-item { padding: 8px 10px; cursor: pointer; }
  .autocomplete-item:hover { background: #333; }

  .message { margin-top: 10px; color: #ddd; font-size: 14px; }

  .poster-container { position: relative; display: inline-block; margin: 20px auto; width: 90%; max-width: 300px; }
  .poster { width: 100%; height: auto; border-radius: 12px; object-fit: cover; transition: filter 1.2s ease; display: block; }

  .guess-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; max-width: 100%; margin: 10px auto; }
  .tile { padding: 6px 4px; border-radius: 6px; font-weight: bold; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .green { background: #4CAF50; } .gray { background: #555; }

  .grid-header .tile { background: #222; font-weight: bold; }

  /* Results overlay */
  .results-overlay {
    position: absolute;
    top: 0; left: 50%; transform: translateX(-50%);
    width: 90%; max-width: 320px;
    background: rgba(0,0,0,0.85);
    padding: 16px;
    border-radius: 12px;
    z-index: 100;
    text-align: center;
  }

  .results-overlay pre { text-align: center; font-size: 18px; margin: 10px 0; }

  .results-overlay button { margin: 6px 0; width: 80%; }

  @media (max-width: 600px) { .tile { font-size: 11px; padding: 4px 2px; } }
  @media (max-width: 400px) { .tile { font-size: 10px; padding: 3px 2px; } }
</style>
</head>
<body>

<h1>ðŸŽ¬ Guess the TV Show</h1>

<div class="autocomplete-container">
  <form id="guess-form">
    <input id="guess-input" name="guess" placeholder="Enter TV show..." autocomplete="off" required />
    <button type="submit">Guess</button>
  </form>
  <div id="autocomplete-results"></div>
</div>

<div id="message" class="message"></div>

<div class="guess-grid grid-header">
  <div class="tile">Network</div>
  <div class="tile">Year</div>
  <div class="tile">Genre</div>
  <div class="tile">Seasons</div>
  <div class="tile">Status</div>
</div>

<div id="guess-grid" class="guess-grid">
  {% if guesses %}
    {% for g in guesses %}
      <div class="tile" style="background:{{ g.compare.network.color }}">{{ g.guess.network }}</div>
      <div class="tile" style="background:{{ g.compare.first_air_year.color }}">{{ g.guess.first_air_year }} {{ g.compare.first_air_year.arrow }}</div>
      <div class="tile" style="background:{{ g.compare.genre.color }}">{{ g.guess.genre }}</div>
      <div class="tile" style="background:{{ g.compare.number_of_seasons.color }}">{{ g.guess.number_of_seasons }} {{ g.compare.number_of_seasons.arrow }}</div>
      <div class="tile" style="background:{{ g.compare.status.color }}">{{ g.guess.status }}</div>
    {% endfor %}
  {% endif %}
</div>

<div class="poster-container">
  {% set remaining = max_guesses - guesses|length %}
  {% set blur_level = (20 * remaining**2) // (max_guesses**2) %}
  {% if target.poster %}
    <img id="poster-img" src="https://image.tmdb.org/t/p/w300{{ target.poster }}" class="poster" style="filter: blur({{ 0 if winner else blur_level }}px);" alt="poster" />
  {% else %}
    <div id="poster-img" class="poster" style="background:#222; height:450px;"></div>
  {% endif %}
</div>

<!-- Results overlay -->
<div id="results-overlay" class="results-overlay" style="display:none;">
  <pre id="emoji-grid"></pre>
  <button id="share-btn">Share Results</button>
  <button id="watch-trailer-btn">Watch Trailer</button>
  <div id="overlay-trailer-container" style="margin-top:10px;"></div>
</div>

<script>
const guessInput = document.getElementById('guess-input');
const autocompleteResults = document.getElementById('autocomplete-results');
const form = document.getElementById('guess-form');
const guessGrid = document.getElementById('guess-grid');
const posterImg = document.getElementById('poster-img');
const messageDiv = document.getElementById('message');

const resultsOverlay = document.getElementById('results-overlay');
const emojiGridEl = document.getElementById('emoji-grid');
const shareBtn = document.getElementById('share-btn');
const watchTrailerBtn = document.getElementById('watch-trailer-btn');
const overlayTrailerContainer = document.getElementById('overlay-trailer-container');

let debounceTimer = null;
let lastQuery = "";

// Render guess grid
function renderGuesses(guesses) {
  if (!Array.isArray(guesses) || guesses.length === 0) { guessGrid.innerHTML = ""; return; }
  let html = "";
  guesses.forEach(g => {
    const comp = g.compare || {};
    html += `<div class="tile" style="background:${comp.network?.color || 'gray'}">${g.guess.network}</div>`;
    html += `<div class="tile" style="background:${comp.first_air_year?.color || 'gray'}">${g.guess.first_air_year} ${comp.first_air_year?.arrow || ''}</div>`;
    html += `<div class="tile" style="background:${comp.genre?.color || 'gray'}">${g.guess.genre}</div>`;
    html += `<div class="tile" style="background:${comp.number_of_seasons?.color || 'gray'}">${g.guess.number_of_seasons} ${comp.number_of_seasons?.arrow || ''}</div>`;
    html += `<div class="tile" style="background:${comp.status?.color || 'gray'}">${g.guess.status}</div>`;
  });
  guessGrid.innerHTML = html;
}

// Build emoji grid
function buildEmojiGrid(guesses) {
  let grid = '';
  guesses.forEach(g => {
    const c = g.compare || {};
    const row = [
      c.network?.color === 'green' ? 'ðŸ“º' : 'â¬›',
      c.first_air_year?.color === 'green' ? 'ðŸ“º' : 'â¬›',
      c.genre?.color === 'green' ? 'ðŸ“º' : 'â¬›',
      c.number_of_seasons?.color === 'green' ? 'ðŸ“º' : 'â¬›',
      c.status?.color === 'green' ? 'ðŸ“º' : 'â¬›'
    ];
    grid += row.join('') + '\n';
  });
  return grid;
}

// Show results overlay
function showResultsOverlay(guesses, trailer) {
  emojiGridEl.textContent = buildEmojiGrid(guesses);
  resultsOverlay.style.display = 'block';

  shareBtn.onclick = () => {
    const textToShare = `${buildEmojiGrid(guesses)}\nPlay here: https://showtime-production-4f0b.up.railway.app/`;
    navigator.clipboard.writeText(textToShare);
    alert("Results copied to clipboard!");
  };

  watchTrailerBtn.onclick = () => {
    if(trailer) {
      overlayTrailerContainer.innerHTML = `<iframe src="${trailer}" frameborder="0" allowfullscreen style="width:100%; height:300px; border-radius:8px;"></iframe>`;
    }
  };
}

// Autocomplete
guessInput.addEventListener('input', (e) => {
  const q = e.target.value.trim();
  if (!q) { autocompleteResults.style.display = 'none'; autocompleteResults.innerHTML = ''; return; }
  if (q === lastQuery) return;
  lastQuery = q;
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(async () => {
    try {
      const res = await fetch(`/autocomplete?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      autocompleteResults.innerHTML = "";
      if (!data.results || data.results.length === 0) { autocompleteResults.style.display = 'none'; return; }
      data.results.forEach(item => {
        const div = document.createElement('div');
        div.className = 'autocomplete-item';
        div.textContent = `${item.name} (${item.year})`;
        div.addEventListener('click', () => { guessInput.value = item.name; autocompleteResults.innerHTML = ""; autocompleteResults.style.display = 'none'; });
        autocompleteResults.appendChild(div);
      });
      autocompleteResults.style.display = 'block';
    } catch (err) { console.error('Autocomplete error', err); autocompleteResults.style.display = 'none'; }
  }, 250);
});
document.addEventListener('click', (e) => { if (!autocompleteResults.contains(e.target) && e.target !== guessInput) autocompleteResults.style.display = 'none'; });

// Submit guess
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const guess = guessInput.value.trim();
  if (!guess) return;
  messageDiv.textContent = "Submitting guess...";
  try {
    const formData = new FormData();
    formData.append('guess', guess);
    const res = await fetch('/guess', { method: 'POST', body: formData });
    const data = await res.json();
    if (res.status !== 200) { messageDiv.textContent = data.error || "Error submitting guess"; return; }

    renderGuesses(data.guesses || []);

    // Update poster blur (less reduction per guess)
    if (posterImg) {
      posterImg.style.filter = `blur(${data.blur_level}px)`;
    }

    if (data.game_over && data.target) {
      showResultsOverlay(data.guesses, data.target.trailer);
    }

    messageDiv.textContent = data.winner ? "ðŸŽ‰ You guessed it!" : "";
    guessInput.value = "";
    autocompleteResults.innerHTML = "";
    autocompleteResults.style.display = "none";
  } catch (err) { console.error(err); messageDiv.textContent = "Network or server error."; }
});

// Show overlay if game already over on page load
{% if game_over %}
showResultsOverlay({{ guesses|tojson }}, "{{ target.trailer }}");
{% endif %}
</script>

</body>
</html>
